<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O-Levels Study Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-red: #d32f2f; --dark-red: #b71c1c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; color: #333; }
        
        header { background-color: var(--primary-red); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--dark-red); }
        .container { max-width: 900px; margin: 30px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        /* Toolbar UI */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-weight: 600; color: #444; outline: none; cursor: pointer; }
        select:focus { border-color: var(--primary-red); }

        .btn-action { padding: 10px 18px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-delete { background: #333; color: white; }
        .btn-delete:hover { background: #000; }
        .btn-delete:disabled { background: #ccc; cursor: not-allowed; }

        /* Table UI */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background-color: #f1f3f5; color: #495057; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; padding: 15px; border-bottom: 2px solid #dee2e6; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
       
        /* Checkbox styling */
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; accent-color: var(--primary-red); }

        .status-attentive { color: #1e7e34; font-weight: bold; }
        .status-distracted { color: var(--primary-red); font-weight: bold; }
        .row-summary { background-color: #fff9f9 !important; font-weight: 900; border-left: 5px solid var(--primary-red) !important; }
       
        #status-msg { text-align: center; padding: 30px; font-style: italic; color: #999; }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-graduation-cap"></i> LIVE.OLEVELS CLOUD</h1>
</header>

<div class="container">
    <div class="toolbar">
        <div>
            <label style="font-weight:bold; margin-right:8px;">View Period:</label>
            <select id="filter-dropdown" onchange="changeFilter(this.value)">
                <option value="day">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="all">All Time</option>
            </select>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button id="delete-btn" class="btn-action btn-delete" onclick="deleteSelected()" disabled>
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button class="btn-action" style="background:#eee;" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <div id="status-msg">Loading history...</div>

    <table id="results-table" style="display: none;">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"></th>
                <th><i class="far fa-clock"></i> Timestamp</th>
                <th><i class="fas fa-poll"></i> Report</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
    let currentFilter = 'day';
    let selectedIds = new Set();

    async function fetchHistory() {
        const tableBody = document.getElementById('table-body');
        const statusMsg = document.getElementById('status-msg');
        const table = document.getElementById('results-table');
        selectedIds.clear();
        updateDeleteButton();

        try {
            const response = await fetch(`/api/get?filter=${currentFilter}`);
            const data = await response.json();

            if (!data || data.length === 0) {
                statusMsg.style.display = "block";
                statusMsg.innerHTML = "No study data found.";
                table.style.display = "none";
                return;
            }

            statusMsg.style.display = "none";
            table.style.display = "table";
            tableBody.innerHTML = "";

            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row.status.includes("SUMMARY") || row.status.includes("5 MIN")) tr.className = "row-summary";

                const isBad = row.status.includes("Not");
                const time = row.time_label || new Date(row.created_at).toLocaleString();

                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" value="${row.id}" onchange="handleRowSelect(this)"></td>
                    <td>${time}</td>
                    <td class="${isBad ? 'status-distracted' : 'status-attentive'}">${row.status}</td>
                `;
                tableBody.appendChild(tr);
            });
        } catch (e) {
            statusMsg.innerHTML = "Error syncing with Cloud.";
        }
    }

    function handleRowSelect(cb) {
        if (cb.checked) selectedIds.add(cb.value);
        else selectedIds.delete(cb.value);
        updateDeleteButton();
    }

    function toggleSelectAll(masterCb) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = masterCb.checked;
            if (cb.checked) selectedIds.add(cb.value);
            else selectedIds.delete(cb.value);
        });
        updateDeleteButton();
    }

    function updateDeleteButton() {
        const btn = document.getElementById('delete-btn');
        btn.disabled = selectedIds.size === 0;
        btn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedIds.size})`;
    }

    async function deleteSelected() {
        if (!confirm(`Delete ${selectedIds.size} selected reports?`)) return;
        
        await fetch('/api/delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: Array.from(selectedIds) })
        });
        fetchHistory();
    }

    async function clearAll() {
        if (!confirm("Permanently wipe ENTIRE cloud history?")) return;
        await fetch('/api/delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ all: true })
        });
        fetchHistory();
    }

    function changeFilter(val) {
        currentFilter = val;
        fetchHistory();
    }

    fetchHistory();
    setInterval(fetchHistory, 30000); // Auto refresh
</script>

</body>
</html>